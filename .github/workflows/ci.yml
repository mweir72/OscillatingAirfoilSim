name: Wing Simulator CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:

  lint:
    name: Lint Code (flake8 + Hadolint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Lint Python code (flake8)
        run: |
          pip install flake8
          flake8 .

      - name: Install Hadolint
        run: |
          wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

      - name: Lint Dockerfile
        run: hadolint Dockerfile

  test:
    name: Run Tests (pytest)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Run pytest
        run: pytest

  security:
    name: Security Scan (Bandit + Trivy)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: Install Bandit
        run: pip install bandit

      - name: Python Security Scan (Bandit)
        run: bandit -r . --skip B101
        working-directory: ${{ github.workspace }}

      - name: Build Docker image
        run: docker build -t wing-sim .

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: wing-sim
          format: table
          exit-code: '0'
          ignore-unfixed: true

  build:
    name: Build and Package Simulator
    runs-on: ubuntu-latest
    needs: security
    steps:
      - uses: actions/checkout@v4

      - name: Build container
        run: docker build -t wing-sim .

      - name: Export Docker image artifact
        run: docker save wing-sim | gzip > wing-sim.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: wing-sim-container
          path: wing-sim.tar.gz
